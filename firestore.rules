rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Fonction pour vérifier si l'utilisateur est membre du bébé
    // Utilise memberIds qui est un tableau simple de strings
    function isUserMember(memberIds) {
      return request.auth != null &&
             request.auth.uid in memberIds;
    }

    // Règles pour les bébés
    match /babies/{babyId} {
      // Lecture : tout utilisateur authentifié peut lire (pour voir l'invitation)
      allow read: if request.auth != null;

      // Création : utilisateur authentifié peut créer un bébé
      allow create: if request.auth != null &&
                      request.resource.data.createdBy == request.auth.uid &&
                      isUserMember(request.resource.data.memberIds);

      // Mise à jour : si l'utilisateur est membre OU s'il s'ajoute comme membre
      allow update: if request.auth != null && (
                      isUserMember(resource.data.memberIds) ||
                      // Permettre d'ajouter son propre userId aux memberIds (accepter invitation)
                      (!isUserMember(resource.data.memberIds) &&
                       isUserMember(request.resource.data.memberIds))
                    );

      // Suppression : seulement le créateur
      allow delete: if request.auth != null &&
                      resource.data.createdBy == request.auth.uid;

      // Événements du bébé
      match /events/{eventId} {
        // Les membres du bébé parent peuvent gérer les événements
        allow read, write: if request.auth != null &&
                             isUserMember(get(/databases/$(database)/documents/babies/$(babyId)).data.memberIds);
      }

      // To-Do liste du bébé
      match /todos/{todoId} {
        // Les membres du bébé parent peuvent gérer les todos
        allow read, write: if request.auth != null &&
                             isUserMember(get(/databases/$(database)/documents/babies/$(babyId)).data.memberIds);
      }
    }

    // Règles pour les paramètres utilisateur (restent par utilisateur)
    match /users/{userId}/settings/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
