<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forcer la mise √† jour - Baby Track</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #0f0f23;
            color: #e0e0e0;
        }
        h1 {
            color: #3b82f6;
            text-align: center;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn.success {
            background: #10b981;
        }
        .btn.danger {
            background: #ef4444;
        }
        .info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .status {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        .status.show {
            display: block;
        }
        .emoji {
            font-size: 2rem;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="emoji">üë∂</div>
    <h1>Forcer la mise √† jour</h1>

    <div class="info">
        <strong>‚ö†Ô∏è Probl√®me d'affichage de l'ancienne version ?</strong>
        <p>Si votre t√©l√©phone affiche toujours l'ancienne version de l'application, utilisez les boutons ci-dessous pour forcer la mise √† jour.</p>
    </div>

    <button class="btn" onclick="clearAllCaches()">
        üóëÔ∏è Vider tous les caches
    </button>

    <button class="btn danger" onclick="unregisterServiceWorkers()">
        ‚öôÔ∏è D√©sinstaller le Service Worker
    </button>

    <button class="btn success" onclick="clearAndReload()">
        üîÑ Tout nettoyer et recharger
    </button>

    <div id="status" class="status">
        <p id="statusText"></p>
    </div>

    <div class="info">
        <strong>üì± Instructions manuelles pour t√©l√©phone :</strong>
        <ol>
            <li>Appuyez sur "Tout nettoyer et recharger"</li>
            <li>Ensuite, allez dans les param√®tres de votre navigateur</li>
            <li>Cherchez "Baby Track" dans les applications install√©es</li>
            <li>Supprimez l'application / les donn√©es du site</li>
            <li>Rechargez la page</li>
        </ol>
        <strong>Chrome Android :</strong> Param√®tres ‚Üí Param√®tres du site ‚Üí Afficher les autorisations et les donn√©es stock√©es pour les sites ‚Üí Baby Track ‚Üí Effacer et r√©initialiser
        <br><br>
        <strong>Safari iOS :</strong> R√©glages ‚Üí Safari ‚Üí Avanc√© ‚Üí Donn√©es de sites web ‚Üí Supprimer Baby Track
    </div>

    <script>
        function showStatus(message) {
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            status.classList.add('show');
        }

        async function clearAllCaches() {
            try {
                // Vider tous les caches
                const cacheNames = await caches.keys();
                await Promise.all(
                    cacheNames.map(cacheName => caches.delete(cacheName))
                );
                showStatus(`‚úÖ ${cacheNames.length} caches supprim√©s avec succ√®s !`);
            } catch (error) {
                showStatus(`‚ùå Erreur : ${error.message}`);
            }
        }

        async function unregisterServiceWorkers() {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                await Promise.all(
                    registrations.map(registration => registration.unregister())
                );
                showStatus(`‚úÖ ${registrations.length} Service Workers d√©sinstall√©s !`);
            } catch (error) {
                showStatus(`‚ùå Erreur : ${error.message}`);
            }
        }

        async function clearAndReload() {
            try {
                // 1. Vider tous les caches
                const cacheNames = await caches.keys();
                await Promise.all(
                    cacheNames.map(cacheName => caches.delete(cacheName))
                );

                // 2. D√©sinstaller tous les Service Workers
                const registrations = await navigator.serviceWorker.getRegistrations();
                await Promise.all(
                    registrations.map(registration => registration.unregister())
                );

                // 3. Vider le localStorage et sessionStorage
                localStorage.clear();
                sessionStorage.clear();

                showStatus('‚úÖ Tout a √©t√© nettoy√© ! Redirection dans 2 secondes...');

                // 4. Recharger la page avec un cache bust
                setTimeout(() => {
                    window.location.href = '/baby-track/?v=' + Date.now();
                }, 2000);
            } catch (error) {
                showStatus(`‚ùå Erreur : ${error.message}`);
            }
        }

        // Afficher l'√©tat actuel
        window.addEventListener('load', async () => {
            const cacheNames = await caches.keys();
            const registrations = await navigator.serviceWorker.getRegistrations();

            let info = `‚ÑπÔ∏è √âtat actuel :\n`;
            info += `- ${cacheNames.length} cache(s) actif(s)\n`;
            info += `- ${registrations.length} Service Worker(s) actif(s)`;

            showStatus(info);
        });
    </script>
</body>
</html>
